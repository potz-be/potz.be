version: '3.5'

name: potz

services:
  traefik:
    image: 'traefik:latest'
    container_name: traefik
    hostname: traefik
    command:
      # Docker
      - '--providers.docker.swarmMode=false'
      - '--providers.docker=true'
      - '--providers.docker.exposedbydefault=false'
      - '--providers.docker.network=main'
      # Configure entrypoints
      - '--entrypoints.web.address=:80'
      - '--entrypoints.websecure.address=:443'
      # HTTPS
      - '--certificatesresolvers.letsencrypt.acme.httpchallenge=true'
      - '--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web'
      - '--certificatesresolvers.letsencrypt.acme.email=jens@jenspots.com'
      - '--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json'
      # Global HTTP -> HTTPS
      - '--entrypoints.web.http.redirections.entryPoint.to=websecure'
      - '--entrypoints.web.http.redirections.entryPoint.scheme=https'
      # Disable dashboard
      - '--api.dashboard=false'
    ports:
      - '443:443'
      - '80:80'
      # Dashboard: - "8080:8080"
    networks:
      potz:
        ipv4_address: 10.0.0.2
    volumes:
      - '~/volumes/traefik:/letsencrypt'
      - '/var/run/docker.sock:/var/run/docker.sock:ro'

  web:
    container_name: potz-web
    hostname: web
    build:
      dockerfile: ./Dockerfile
      context: .
      target: 'production'
      args:
        FOO: bar
    networks:
      potz:
        ipv4_address: 10.0.0.3
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.web.rule=Host(`potz.be`)'
      - 'traefik.http.routers.web.rule=PathPrefix(`/`)'
      - 'traefik.http.routers.web.entrypoints=websecure'
      - 'traefik.http.routers.web.tls.certresolver=letsencrypt'
      - 'traefik.http.services.web.loadbalancer.server.port=3000'
    restart: always

networks:
  potz:
    name: potz
    ipam:
      config:
        - subnet: 10.0.0.0/24
